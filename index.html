<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8" />
 <title>Million Tile Video Wall</title>
 <meta name="viewport" content="width=device-width, initial-scale=1.0" />
 <style>
 /* Banner Styles */
 #banner {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background-color: #f0c14b;
  color: #000;
  text-align: center;
  padding: 10px 0;
  z-index: 1000;
  font-size: 16px;
  display: flex;
  justify-content: center;
  align-items: center;
 }

 #banner a {
  color: #000;
  text-decoration: none;
  font-weight: bold;
  margin-right: 20px; /* Spacing between link and button */
 }

 #banner a:hover {
  text-decoration: underline;
 }

 /* Button Styles */
 #playAllButton, #toggleNumbersButton {
  background-color: #4CAF50; /* Green */
  border: none;
  color: white;
  padding: 8px 16px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  cursor: pointer;
  border-radius: 5px;
  margin-left: 10px; /* Space between buttons */
 }

 /* Tile Number Styles */
 .tile-number {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 20px;
  background: rgba(0, 0, 0, 0.7);
  color: white;
  text-align: center;
  line-height: 20px;
  font-size: 12px;
  opacity: 1;
  transition: opacity 0.3s ease;
 }

 .tile:hover .tile-number {
  opacity: 1;
 }

 /* Hidden Tile Number Style */
 .tile-number.hidden {
  display: none;
 }

 /* Existing Styles - unchanged */
 html, body {
  margin: 0;
  height: 100%;
  overflow: hidden;
  background: #000;
  font-family: sans-serif;
  color: white;
 }

 #viewport {
  width: 100vw;
  height: 100vh;
  overflow: auto;
  position: relative;
  top: 40px;
 }

 #grid {
  position: relative;
  width: 160000px;
  height: 90000px;
 }

 .tile {
  position: absolute;
  width: 160px;
  height: 90px;
  background: #222;
  overflow: hidden;
  cursor: pointer;
 }

 .tile img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  object-position: center;
 }

 .iframe-container {
  width: 100%;
  height: 100%;
 }

 .iframe-container iframe {
  width: 100%;
  height: 100%;
  border: none;
 }
 </style>
</head>

<body>
 <div id="banner">
  <a href="https://www.indiegogo.com/projects/ssrt-world-s-first-smart-solar-roof-tile" target="_blank">
  Support the Million Tile Video Wall on Indiegogo!
  </a>
  <button id="playAllButton">Play Visible Videos</button>
  <button id="toggleNumbersButton">Toggle Numbers</button>
 </div>

 <div id="viewport">
  <div id="grid"></div>
 </div>

 <script>
  const viewport = document.getElementById('viewport');
  const grid = document.getElementById('grid');
  const playAllButton = document.getElementById('playAllButton');
  const toggleNumbersButton = document.getElementById('toggleNumbersButton');

  const TILE_WIDTH = 160;
  const TILE_HEIGHT = 90;
  const GRID_COLS = 10;
  const GRID_ROWS = 10;

  const sampleVideos = [
  "twQCZWBbcRE","AHZbB-bfh-k","hr8ZQ-Qybg8","AZ_eiVs91_I","YrgQDETGO00","aOgJXd93HLg","1gFSDD12RP8","xXp4iNBFL88","b1gE2G7yFzo","cESaIUWoCJQ",
  "5R6bBNnZgDE","AZ_eiVs91_I","k48e9GzcQVM","5VAT_rUbLYE","Au3H5cYTUI8","V_f8Q2_Q_J0","AHZbB-bfh-k","9Qs5-_DOkVE","COvy3uC7t_E","9J4eS6I5_s0",
  "Au3H5cYTUI8","J3i3F2e4IYs","V_f8Q2_Q_J0","NteGUDYZ1nE","Au3H5cYTUI8","COvy3uC7t_E","J3i3F2e4IYs","YrgQDETGO00","8xgnm6SynH4","9J4eS6I5_s0",
  "V_f8Q2_Q_J0","b1gE2G7yFzo","J3i3F2e4IYs","k48e9GzcQVM","COvy3uC7t_E","YrgQDETGO00","AZ_eiVs91_I","cESaIUWoCJQ","k48e9GzcQVM","V_f8Q2_Q_J0",
  "twQCZWBbcRE","5R6bBNnZgDE","8xgnm6SynH4","NteGUDYZ1nE","9J4eS6I5_s0","aOgJXd93HLg","COvy3uC7t_E","hr8ZQ-Qybg8","5R6bBNnZgDE","9J4eS6I5_s0",
  "J3i3F2e4IYs","5VAT_rUbLYE","k48e9G9zcQVM","V_f8Q2_Q_J0","NteGUDYZ1nE","5R6bBNnZgDE","hr8ZQ-Qybg8","xXp4iNBFL88","b1gE2G7yFzo","AZ_eiVs91_I",
  "twQCZWBbcRE","9Qs5-_DOkVE","9J4eS6I5_s0","9Qs5-_DOkVE","cESaIUWoCJQ","YrgQDETGO00","V_f8Q2_Q_J0","AHZbB-bfh-k","AHZbB-bfh-k","AHZbB-bfh-k",
  "1gFSDD12RP8","8xgnm6SynH4","NteGUDYZ1nE","Au3H5cYTUI8","hr8ZQ-Qybg8","b1gE2G7yFzo","Au3H5cYTUI8","1gFSDD12RP8","COvy3uC7t_E","hr8ZQ-Qybg8",
  "5VAT_rUbLYE","AZ_eiVs91_I","k48e9GzcQVM","b1gE2G7yFzo","J3i3F2e4IYs","YrgQDETGO00","V_f8Q2_Q_J0","twQCZWBbcRE","xXp4iNBFL88","aOgJXd93HLg",
  "1gFSDD12RP8","9Qs5-_DOkVE","twQCZWBbcRE","NteGUDYZ1nE","5VAT_rUbLYE","YrgQDETGO00","cESaIUWoCJQ","5R6bBNnZgDE","xXp4iNBFL88"
  ];

  let tileNumbersVisible = true; // Track visibility state
  const visibleTiles = {}; // Stores references to currently DOM-rendered tiles
  const pendingPlaybacks = new Map(); // Stores timeout IDs for videos waiting to play

  /**
   * Helper function to play a video in a given tile.
   * Replaces the thumbnail with the YouTube iframe.
   * @param {HTMLElement} tile The tile element.
   * @param {string} youtubeId The YouTube video ID.
   * @param {boolean} autoplay Whether the video should autoplay.
   */
  function playVideoInTile(tile, youtubeId, autoplay = true) {
    // If the tile is already playing a video, do nothing
    if (tile.querySelector('iframe')) {
      return;
    }

    tile.innerHTML = `
      <div class="iframe-container">
        <iframe
          src="https://www.youtube.com/embed/${youtubeId}?autoplay=${autoplay ? 1 : 0}&mute=1&playsinline=1&modestbranding=1"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
          allowfullscreen
        ></iframe>
      </div>`;
    // Optionally re-add tile number if it was present
    const tileNumber = tile.querySelector('.tile-number');
    if (tileNumber && !tileNumbersVisible) { // If numbers are hidden, hide it again after re-rendering
      tileNumber.classList.add('hidden');
    }
  }

  /**
   * Helper function to reset a tile back to its thumbnail state.
   * @param {HTMLElement} tile The tile element.
   * @param {string} youtubeId The YouTube video ID.
   * @param {number} tileIndex The index of the tile for number display.
   */
  function resetTileToThumbnail(tile, youtubeId, tileIndex) {
    // Only reset if it's currently an iframe
    if (tile.querySelector('iframe')) {
      tile.innerHTML = ''; // Clear existing content

      const img = document.createElement("img");
      img.src = `http://img.youtube.com/vi/${youtubeId}/hqdefault.jpg`;
      img.alt = `Tile ${tileIndex}`;
      tile.appendChild(img);

      const tileNumber = document.createElement("div");
      tileNumber.className = "tile-number";
      tileNumber.textContent = tileIndex + 1;
      if (!tileNumbersVisible) {
        tileNumber.classList.add('hidden');
      }
      tile.appendChild(tileNumber);

      // Re-attach click listener for individual playback
      tile.addEventListener("click", () => {
        playVideoInTile(tile, youtubeId, true); // Autoplay on individual click
      }, { once: true }); // Play once and then remove this specific listener
    }
  }

  // Intersection Observer for delayed playback
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      const tile = entry.target;
      const key = tile.dataset.key; // Get the key stored on the tile element
      const youtubeId = tile.dataset.youtubeId; // Get the youtubeId stored on the tile element
      const tileIndex = parseInt(tile.dataset.tileIndex); // Get tile index

      if (entry.isIntersecting) {
        // Tile entered viewport
        // If there's no pending playback for this tile, start a timer
        if (!pendingPlaybacks.has(key)) {
          const timeoutId = setTimeout(() => {
            playVideoInTile(tile, youtubeId, true); // Auto-play after 5 seconds
            pendingPlaybacks.delete(key); // Clear from map after playing
          }, 5000); // 5-second delay
          pendingPlaybacks.set(key, timeoutId);
        }
      } else {
        // Tile left viewport
        // Clear any pending playback timer
        if (pendingPlaybacks.has(key)) {
          clearTimeout(pendingPlaybacks.get(key));
          pendingPlaybacks.delete(key);
        }
        // If it was playing, reset it to thumbnail
        resetTileToThumbnail(tile, youtubeId, tileIndex);
      }
    });
  }, {
    root: viewport, // Observe within the viewport div
    threshold: 0.8 // Trigger when at least 80% of the tile is visible
  });

  function renderTiles() {
    const scrollLeft = viewport.scrollLeft;
    const scrollTop = viewport.scrollTop;
    const viewportWidth = viewport.clientWidth;
    const viewportHeight = viewport.clientHeight;

    const startCol = Math.floor(scrollLeft / TILE_WIDTH);
    const endCol = Math.min(GRID_COLS, Math.ceil((scrollLeft + viewportWidth) / TILE_WIDTH));
    const startRow = Math.floor(scrollTop / TILE_HEIGHT);
    const endRow = Math.min(GRID_ROWS, Math.ceil((scrollTop + viewportHeight) / TILE_HEIGHT));

    const newVisibleKeys = {};

    for (let row = startRow; row < endRow; row++) {
      for (let col = startCol; col < endCol; col++) {
        const key = `${row}_${col}`;
        newVisibleKeys[key] = true;

        if (!visibleTiles[key]) {
          const tileIndex = (row * GRID_COLS + col);
          const youtubeId = sampleVideos[tileIndex % sampleVideos.length];

          const tile = document.createElement("div");
          tile.className = "tile";
          tile.style.top = `${row * TILE_HEIGHT}px`;
          tile.style.left = `${col * TILE_WIDTH}px`;
          tile.dataset.key = key; // Store key for observer
          tile.dataset.youtubeId = youtubeId; // Store youtubeId for observer
          tile.dataset.tileIndex = tileIndex; // Store tile index

          const img = document.createElement("img");
          img.src = `http://img.youtube.com/vi/${youtubeId}/hqdefault.jpg`;
          img.alt = `Tile ${row}, ${col}`;
          tile.appendChild(img);

          const tileNumber = document.createElement("div");
          tileNumber.className = "tile-number";
          tileNumber.textContent = tileIndex + 1;
          if (!tileNumbersVisible) {
            tileNumber.classList.add('hidden');
          }
          tile.appendChild(tileNumber);

          // Individual click to play immediately
          tile.addEventListener("click", function handler() {
            playVideoInTile(tile, youtubeId, true);
            // Remove this specific listener after first click to prevent re-attaching
            // It will be re-attached if the tile is reset to thumbnail
            tile.removeEventListener("click", handler);
          });

          grid.appendChild(tile);
          visibleTiles[key] = tile;
          observer.observe(tile); // Start observing the new tile
        }
      }
    }

    for (let key in visibleTiles) {
      if (!newVisibleKeys[key]) {
        // Tile is no longer visible, remove from DOM and unobserve
        observer.unobserve(visibleTiles[key]);
        // Clear any pending playback timer for this tile
        if (pendingPlaybacks.has(key)) {
          clearTimeout(pendingPlaybacks.get(key));
          pendingPlaybacks.delete(key);
        }
        grid.removeChild(visibleTiles[key]);
        delete visibleTiles[key];
      }
    }
  }

  renderTiles();

  // Play Visible Videos functionality (bypasses 5-second delay)
  playAllButton.addEventListener('click', () => {
    // Collect keys of currently visible tiles from the visibleTiles object
    const currentVisibleKeys = Object.keys(visibleTiles);

    currentVisibleKeys.forEach(key => {
      const tileElement = visibleTiles[key];
      const youtubeId = tileElement.dataset.youtubeId;

      // Clear any pending timeout for this tile as it will play immediately
      if (pendingPlaybacks.has(key)) {
        clearTimeout(pendingPlaybacks.get(key));
        pendingPlaybacks.delete(key);
      }

      // Play the video immediately
      playVideoInTile(tileElement, youtubeId, true);
    });
  });

  // Toggle Numbers Functionality
  toggleNumbersButton.addEventListener('click', () => {
    tileNumbersVisible = !tileNumbersVisible;
    for (let key in visibleTiles) {
      const tileNumber = visibleTiles[key].querySelector('.tile-number');
      if (tileNumber) {
        tileNumber.classList.toggle('hidden', !tileNumbersVisible);
      }
    }
  });

  viewport.addEventListener("scroll", () => {
    requestAnimationFrame(renderTiles);
  });
 </script>
</body>
</html>
